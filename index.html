<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>あみだくじ
</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background: #f7f7f7;
    margin: 0;
    padding: 10px;
  }
  canvas {
    touch-action: manipulation;
  }
</style>
</head>
<body>

<h3>あみだくじ
</h3>
<p>スタートをタップ</p>

<button onclick="resetAll()">リセット</button><br><br>

<canvas id="c" width="420" height="560"
 style="border:1px solid black;background:white;"></canvas>

<br>
<div>
  G1：ゆうこのマンコ<br>
  G2：みなみのマンコ<br>
  G3：あや　のマンコ<br>
  G4：りな　の　くち<br>
  G5：りな　のマンコ<br>
  G6：りな　のアナル<br>
  G7：りな　の穴全部　　
</div>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

ctx.font = "14px sans-serif";

const LINES = 7;
const TOP = 60;
const BOTTOM = 480;
const SPACE = 50;
const LEFT = 40;

const COLORS = ["red","blue","green","orange","purple","brown","teal"];

let bars = [];
let animating = false;

let goalColor  = new Array(LINES).fill("black");
let startColor = new Array(LINES).fill("black");
let drawnPaths = [];

function generateBars(){
  const MIN_MOVE = 3;
  const LEVELS = 12;
  const MAX_TRY = 500;

  for(let trial=0; trial<MAX_TRY; trial++){
    bars = [];

    for(let i=0;i<LEVELS;i++){
      let y = 100 + i * 30;
      let x = Math.floor(Math.random() * (LINES - 1));
      bars.push({x:x, y:y});
    }

    let moved = new Array(LINES).fill(0);

    for(let s=0; s<LINES; s++){
      let x = s;
      for(let b of bars){
        if(b.x === x){ x++; moved[s]++; }
        else if(b.x === x-1){ x--; moved[s]++; }
      }
    }

    if(moved.every(v => v >= MIN_MOVE)) return;
  }
}

function drawBase(){
  ctx.clearRect(0,0,c.width,c.height);

  ctx.strokeStyle = "black";
  ctx.lineWidth = 2;

  for(let i=0;i<LINES;i++){
    let x = LEFT + i*SPACE;

    ctx.beginPath();
    ctx.moveTo(x,TOP);
    ctx.lineTo(x,BOTTOM);
    ctx.stroke();

    ctx.fillStyle = startColor[i];
    ctx.fillText("S"+(i+1), x-10, TOP-20);

    ctx.fillStyle = goalColor[i];
    ctx.fillText("G"+(i+1), x-10, BOTTOM+30);
  }

  for(let b of bars){
    let x1 = LEFT + b.x*SPACE;
    let x2 = x1 + SPACE;
    ctx.beginPath();
    ctx.moveTo(x1, b.y);
    ctx.lineTo(x2, b.y);
    ctx.stroke();
  }

  for(let p of drawnPaths){
    ctx.strokeStyle = p.color;
    ctx.lineWidth = 3;
    for(let s of p.path){
      ctx.beginPath();
      ctx.moveTo(LEFT + s[0]*SPACE, s[1]);
      ctx.lineTo(LEFT + s[2]*SPACE, s[3]);
      ctx.stroke();
    }
  }
}

function traceAnimated(start){
  if(animating) return;
  animating = true;

  startColor[start] = COLORS[start];
  drawBase();

  let x = start;
  let y = TOP;
  let path = [];

  for(let b of bars){
    if(b.x === x){
      path.push([x,y,x,b.y]);
      path.push([x,b.y,x+1,b.y]);
      x++; y = b.y;
    }
    else if(b.x === x-1){
      path.push([x,y,x,b.y]);
      path.push([x,b.y,x-1,b.y]);
      x--; y = b.y;
    }
  }
  path.push([x,y,x,BOTTOM]);

  let goal = x;
  let i = 0;

  ctx.strokeStyle = COLORS[start];
  ctx.lineWidth = 3;

  function step(){
    if(i >= path.length){
      goalColor[goal] = COLORS[start];
      drawnPaths.push({ color: COLORS[start], path: path });
      animating = false;
      drawBase();
      return;
    }

    let s = path[i];
    ctx.beginPath();
    ctx.moveTo(LEFT + s[0]*SPACE, s[1]);
    ctx.lineTo(LEFT + s[2]*SPACE, s[3]);
    ctx.stroke();

    i++;
    setTimeout(step, 150);
  }
  step();
}

c.addEventListener("click", e=>{
  const r = c.getBoundingClientRect();
  const tx = e.clientX - r.left;

  for(let i=0;i<LINES;i++){
    let lx = LEFT + i*SPACE;
    if(Math.abs(tx - lx) < 15){
      traceAnimated(i);
      break;
    }
  }
});

function resetAll(){
  goalColor.fill("black");
  startColor.fill("black");
  drawnPaths = [];
  generateBars();
  drawBase();
}

generateBars();
drawBase();
</script>

</body>
</html>
